console.log(" iRingo: ⭕ Siri Request");const e=function(){if("undefined"!=typeof $environment&&$environment["surge-version"])return"Surge";if("undefined"!=typeof $environment&&$environment["stash-version"])return"Stash";if("undefined"!=typeof module&&module.exports)return"Node.js";if("undefined"!=typeof $task)return"Quantumult X";if("undefined"!=typeof $loon)return"Loon";if("undefined"!=typeof $rocket)return"Shadowrocket";if("undefined"!=typeof Egern)return"Egern"}();class t{static name="Lodash";static version="1.2.2";static about(){return console.log(`\n🟧 ${this.name} v${this.version}\n`)}static get(e={},t="",s=void 0){Array.isArray(t)||(t=this.toPath(t));const a=t.reduce(((e,t)=>Object(e)[t]),e);return void 0===a?s:a}static set(e={},t="",s){return Array.isArray(t)||(t=this.toPath(t)),t.slice(0,-1).reduce(((e,s,a)=>Object(e[s])===e[s]?e[s]:e[s]=/^\d+$/.test(t[a+1])?[]:{}),e)[t[t.length-1]]=s,e}static unset(e={},t=""){return Array.isArray(t)||(t=this.toPath(t)),t.reduce(((e,s,a)=>a===t.length-1?(delete e[s],!0):Object(e)[s]),e)}static toPath(e){return e.replace(/\[(\d+)\]/g,".$1").split(".").filter(Boolean)}static escape(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,(e=>t[e]))}static unescape(e){const t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};return e.replace(/&amp;|&lt;|&gt;|&quot;|&#39;/g,(e=>t[e]))}}class s{static name="Storage";static version="1.1.0";static about(){return r("",`🟧 ${this.name} v${this.version}`,"")}static data=null;static dataFile="box.dat";static#e=/^@(?<key>[^.]+)(?:\.(?<path>.*))?$/;static getItem(s=new String,a=null){let r=a;if(!0===s.startsWith("@")){const{key:e,path:a}=s.match(this.#e)?.groups;s=e;let i=this.getItem(s,{});"object"!=typeof i&&(i={}),r=t.get(i,a);try{r=JSON.parse(r)}catch(e){}}else{switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":r=$persistentStore.read(s);break;case"Quantumult X":r=$prefs.valueForKey(s);break;case"Node.js":this.data=this.#t(this.dataFile),r=this.data?.[s];break;default:r=this.data?.[s]||null}try{r=JSON.parse(r)}catch(e){}}return r??a}static setItem(s=new String,a=new String){let r=!1;if("object"==typeof a)a=JSON.stringify(a);else a=String(a);if(!0===s.startsWith("@")){const{key:e,path:i}=s.match(this.#e)?.groups;s=e;let o=this.getItem(s,{});"object"!=typeof o&&(o={}),t.set(o,i,a),r=this.setItem(s,o)}else switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":r=$persistentStore.write(a,s);break;case"Quantumult X":r=$prefs.setValueForKey(a,s);break;case"Node.js":this.data=this.#t(this.dataFile),this.data[s]=a,this.#s(this.dataFile),r=!0;break;default:r=this.data?.[s]||null}return r}static removeItem(s){let a=!1;if(!0===s.startsWith("@")){const{key:e,path:r}=s.match(this.#e)?.groups;s=e;let i=this.getItem(s);"object"!=typeof i&&(i={}),keyValue=t.unset(i,r),a=this.setItem(s,i)}else switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":default:a=!1;break;case"Quantumult X":a=$prefs.removeValueForKey(s)}return a}static clear(){let t=!1;switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":default:t=!1;break;case"Quantumult X":t=$prefs.removeAllValues()}return t}static#t(e){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(e),s=this.path.resolve(process.cwd(),e),a=this.fs.existsSync(t),r=!a&&this.fs.existsSync(s);if(!a&&!r)return{};{const e=a?t:s;try{return JSON.parse(this.fs.readFileSync(e))}catch(e){return{}}}}}static#s(e=this.dataFile){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(e),s=this.path.resolve(process.cwd(),e),a=this.fs.existsSync(t),r=!a&&this.fs.existsSync(s),i=JSON.stringify(this.data);a?this.fs.writeFileSync(t,i):r?this.fs.writeFileSync(s,i):this.fs.writeFileSync(t,i)}}}function a(s={}){switch(e){case"Surge":s.policy&&t.set(s,"headers.X-Surge-Policy",s.policy),r("",`🚩 执行结束! 🕛 ${(new Date).getTime()/1e3-$script.startTime} 秒`,""),$done(s);break;case"Loon":s.policy&&(s.node=s.policy),r("",`🚩 执行结束! 🕛 ${(new Date-$script.startTime)/1e3} 秒`,""),$done(s);break;case"Stash":s.policy&&t.set(s,"headers.X-Stash-Selected-Proxy",encodeURI(s.policy)),r("",`🚩 执行结束! 🕛 ${(new Date-$script.startTime)/1e3} 秒`,""),$done(s);break;case"Egern":case"Shadowrocket":default:r("","🚩 执行结束!",""),$done(s);break;case"Quantumult X":s.policy&&t.set(s,"opts.policy",s.policy),delete s["auto-redirect"],delete s["auto-cookie"],delete s["binary-mode"],delete s.charset,delete s.host,delete s.insecure,delete s.method,delete s.opt,delete s.path,delete s.policy,delete s["policy-descriptor"],delete s.scheme,delete s.sessionIndex,delete s.statusCode,delete s.timeout,s.body instanceof ArrayBuffer?(s.bodyBytes=s.body,delete s.body):ArrayBuffer.isView(s.body)?(s.bodyBytes=s.body.buffer.slice(s.body.byteOffset,s.body.byteLength+s.body.byteOffset),delete s.body):s.body&&delete s.bodyBytes,r("","🚩 执行结束!",""),$done(s);break;case"Node.js":r("","🚩 执行结束!",""),process.exit(1)}}const r=(...e)=>console.log(e.join("\n"));var i={Siri:{Settings:{Switch:!0,CountryCode:"SG",Region:"AUTO",Domains:["web","itunes","app_store","movies","restaurants","maps"],Functions:["flightutilities","lookup","mail","messages","news","safari","siri","spotlight","visualintelligence"],Safari_Smart_History:!0},Configs:{VisualIntelligence:{enabled_domains:["pets","media","books","art","nature","landmarks"],supported_domains:["ART","BOOK","MEDIA","LANDMARK","ANIMALS","BIRDS","FOOD","SIGN_SYMBOL","AUTO_SYMBOL","DOGS","NATURE","NATURAL_LANDMARK","INSECTS","REPTILES","ALBUM","STOREFRONT","LAUNDRY_CARE_SYMBOL","CATS","OBJECT_2D","SCULPTURE","SKYLINE","MAMMALS"]},Storefront:{AE:"143481",AF:"143610",AG:"143540",AI:"143538",AL:"143575",AM:"143524",AO:"143564",AR:"143505",AT:"143445",AU:"143460",AZ:"143568",BA:"143612",BB:"143541",BD:"143490",BE:"143446",BF:"143578",BG:"143526",BH:"143559",BJ:"143576",BM:"143542",BN:"143560",BO:"143556",BR:"143503",BS:"143539",BT:"143577",BW:"143525",BY:"143565",BZ:"143555",CA:"143455",CD:"143613",CG:"143582",CH:"143459",CI:"143527",CL:"143483",CM:"143574",CN:"143465",CO:"143501",CR:"143495",CV:"143580",CY:"143557",CZ:"143489",DE:"143443",DK:"143458",DM:"143545",DO:"143508",DZ:"143563",EC:"143509",EE:"143518",EG:"143516",ES:"143454",FI:"143447",FJ:"143583",FM:"143591",FR:"143442",GA:"143614",GB:"143444",GD:"143546",GF:"143615",GH:"143573",GM:"143584",GR:"143448",GT:"143504",GW:"143585",GY:"143553",HK:"143463",HN:"143510",HR:"143494",HU:"143482",ID:"143476",IE:"143449",IL:"143491",IN:"143467",IQ:"143617",IS:"143558",IT:"143450",JM:"143511",JO:"143528",JP:"143462",KE:"143529",KG:"143586",KH:"143579",KN:"143548",KP:"143466",KR:"143466",KW:"143493",KY:"143544",KZ:"143517",TC:"143552",TD:"143581",TJ:"143603",TH:"143475",TM:"143604",TN:"143536",TO:"143608",TR:"143480",TT:"143551",TW:"143470",TZ:"143572",LA:"143587",LB:"143497",LC:"143549",LI:"143522",LK:"143486",LR:"143588",LT:"143520",LU:"143451",LV:"143519",LY:"143567",MA:"143620",MD:"143523",ME:"143619",MG:"143531",MK:"143530",ML:"143532",MM:"143570",MN:"143592",MO:"143515",MR:"143590",MS:"143547",MT:"143521",MU:"143533",MV:"143488",MW:"143589",MX:"143468",MY:"143473",MZ:"143593",NA:"143594",NE:"143534",NG:"143561",NI:"143512",NL:"143452",NO:"143457",NP:"143484",NR:"143606",NZ:"143461",OM:"143562",PA:"143485",PE:"143507",PG:"143597",PH:"143474",PK:"143477",PL:"143478",PT:"143453",PW:"143595",PY:"143513",QA:"143498",RO:"143487",RS:"143500",RU:"143469",RW:"143621",SA:"143479",SB:"143601",SC:"143599",SE:"143456",SG:"143464",SI:"143499",SK:"143496",SL:"143600",SN:"143535",SR:"143554",ST:"143598",SV:"143506",SZ:"143602",UA:"143492",UG:"143537",US:"143441",UY:"143514",UZ:"143566",VC:"143550",VE:"143502",VG:"143543",VN:"143471",VU:"143609",XK:"143624",YE:"143571",ZA:"143472",ZM:"143622",ZW:"143605"}}}};function o(e,a,i){r("☑️ Set Environment Variables","");let{Settings:o,Caches:c,Configs:n}=function(e,a,r){let i=s.getItem(e,r),o={};switch(typeof $argument){case"string":let e=Object.fromEntries($argument.split("&").map((e=>e.split("=").map((e=>e.replace(/\"/g,""))))));for(let s in e)t.set(o,s,e[s]);break;case"object":for(let e in $argument)t.set(o,e,$argument[e])}const c={Settings:r?.Default?.Settings||{},Configs:r?.Default?.Configs||{},Caches:{}};Array.isArray(a)||(a=[a]);for(let e of a)c.Settings={...c.Settings,...r?.[e]?.Settings,...o,...i?.[e]?.Settings},c.Configs={...c.Configs,...r?.[e]?.Configs},i?.[e]?.Caches&&"string"==typeof i?.[e]?.Caches&&(i[e].Caches=JSON.parse(i?.[e]?.Caches)),c.Caches={...c.Caches,...i?.[e]?.Caches};return function e(t,s){for(var a in t){var r=t[a];t[a]="object"==typeof r&&null!==r?e(r,s):s(a,r)}return t}(c.Settings,((e,t)=>("true"===t||"false"===t?t=JSON.parse(t):"string"==typeof t&&(t=t.includes(",")?t.split(",").map((e=>n(e))):n(t)),t))),c;function n(e){return e&&!isNaN(e)&&(e=parseInt(e,10)),e}}(e,a,i);switch(a){case"WeatherKit":Array.isArray(o?.AQI?.ReplaceProviders)||t.set(o,"AQI.ReplaceProviders",o?.AQI?.ReplaceProviders?[o.AQI.ReplaceProviders.toString()]:[]),o.AQI.ReplaceProviders.includes("TWC")&&o.AQI.ReplaceProviders.push("The Weather Channel"),o.AQI.ReplaceProviders.includes("QWeather")&&o.AQI.ReplaceProviders.push("和风天气"),o.AQI.ReplaceProviders.push(void 0),Array.isArray(o?.AQI?.Local?.ReplaceScales)||t.set(o,"AQI.Local.ReplaceScales",o?.AQI?.Local?.ReplaceScales?[o.AQI.Local.ReplaceScales.toString()]:[]);break;case"Siri":Array.isArray(o?.Domains)||t.set(o,"Domains",o?.Domains?[o.Domains.toString()]:[]),Array.isArray(o?.Functions)||t.set(o,"Functions",o?.Functions?[o.Functions.toString()]:[]);break;case"TV":Array.isArray(o?.Tabs)||t.set(o,"Tabs",o?.Tabs?[o.Tabs.toString()]:[])}if(r(`✅ Set Environment Variables, Settings: ${typeof o}, Settings内容: ${JSON.stringify(o)}`,""),n.Locale&&(n.Locale=new Map(n.Locale)),n.i18n)for(let e in n.i18n)n.i18n[e]=new Map(n.i18n[e]);return{Settings:o,Caches:c,Configs:n}}let c;r("v4.0.1(4011)");const n=new class{constructor(e,t=void 0){return console.log("\n🟧 URL v2.1.2\n"),e=this.#a(e,t),this}#a(e,t=void 0){const s=/(?:(?<protocol>\w+:)\/\/(?:(?<username>[^\s:"]+)(?::(?<password>[^\s:"]+))?@)?(?<host>[^\s@/]+))?(?<pathname>\/?[^\s@?]+)?(?<search>\?[^\s?]+)?/,a=/(?<hostname>.+):(?<port>\d+)$/;if(e=e.match(s)?.groups||{},t&&(!(t=t?.match(s)?.groups||{}).protocol||!t.hostname))throw new Error(`🚨 ${name}, ${t} is not a valid URL`);if((e.protocol||t?.protocol)&&(this.protocol=e.protocol||t.protocol),(e.username||t?.username)&&(this.username=e.username||t.username),(e.password||t?.password)&&(this.password=e.password||t.password),(e.host||t?.host)&&(this.host=e.host||t.host,Object.freeze(this.host),this.hostname=this.host.match(a)?.groups.hostname??this.host,this.port=this.host.match(a)?.groups.port??""),e.pathname||t?.pathname){if(this.pathname=e.pathname||t?.pathname,this.pathname.startsWith("/")||(this.pathname="/"+this.pathname),this.paths=this.pathname.split("/").filter(Boolean),Object.freeze(this.paths),this.paths){const e=this.paths[this.paths.length-1];if(e?.includes(".")){const t=e.split(".");this.format=t[t.length-1],Object.freeze(this.format)}}}else this.pathname="";return(e.search||t?.search)&&(this.search=e.search||t.search,Object.freeze(this.search),this.search&&(this.searchParams=this.search.slice(1).split("&").map((e=>e.split("="))))),this.searchParams=new Map(this.searchParams||[]),this.harf=this.toString(),Object.freeze(this.harf),this}toString(){let e="";return this.protocol&&(e+=this.protocol+"//"),this.username&&(e+=this.username+(this.password?":"+this.password:"")+"@"),this.hostname&&(e+=this.hostname),this.port&&(e+=":"+this.port),this.pathname&&(e+=this.pathname),0!==this.searchParams.size&&(e+="?"+Array.from(this.searchParams).map((e=>e.join("="))).join("&")),e}toJSON(){return JSON.stringify({...this})}}($request.url);r(`⚠ url: ${n.toJSON()}`,"");const h=$request.method,l=n.hostname,p=n.pathname;n.pathname.split("/").filter(Boolean),r(`⚠ METHOD: ${h}, HOST: ${l}, PATH: ${p}`,"");const u=($request.headers?.["Content-Type"]??$request.headers?.["content-type"])?.split(";")?.[0];r(`⚠ FORMAT: ${u}`,""),(async()=>{const{Settings:e,Caches:t,Configs:s}=o("iRingo","Siri",i);switch(r(`⚠ Settings.Switch: ${e?.Switch}`,""),e.Switch){case!0:default:let t,s,a;switch(h){case"POST":case"PUT":case"PATCH":case"DELETE":case"GET":case"HEAD":case"OPTIONS":default:if(t=t??n.searchParams.get("locale"),[s,a]=t?.split("_")??[],r(`🚧 Locale: ${t}, Language: ${s}, CountryCode: ${a}`,""),"AUTO"===e.CountryCode)e.CountryCode=a;else n.searchParams.has("cc")&&n.searchParams.set("cc",e.CountryCode);switch(l){case"api.smoot.apple.cn":case"api.smoot.apple.com":case"api2.smoot.apple.com":case"api-siri.smoot.apple.com":default:let t=n.searchParams.get("q");switch(p){case"/bag":break;case"/search":if("zkw"===n.searchParams.get("qtype"))switch(e.CountryCode){case"CN":case"HK":case"MO":case"TW":case"SG":n.searchParams.set("locale",`${s}_SG`);break;case"US":case"CA":case"UK":case"AU":break;default:n.searchParams.set("locale",`${s}_US`)}else t?.startsWith?.("%E5%A4%A9%E6%B0%94%20")?(console.log("'天气 '开头"),n.searchParams.set("q",t.replace(/%E5%A4%A9%E6%B0%94/,"weather")),/^weather%20.*%E5%B8%82$/.test(t)&&n.searchParams.set("q",t.replace(/$/,"%E5%B8%82"))):t?.endsWith?.("%20%E5%A4%A9%E6%B0%94")&&(console.log("' 天气'结尾"),n.searchParams.set("q",t.replace(/%E5%A4%A9%E6%B0%94/,"weather")),/.*%E5%B8%82%20weather$/.test(t)&&n.searchParams.set("q",t.replace(/%20weather$/,"%E5%B8%82%20weather")));break;case"/card":switch(n.searchParams.get("include")){case"tv":case"movies":n.searchParams.set("card_locale",`${s}_${e.CountryCode}`);const a=n.searchParams.get("storefront")?.match(/[\d]{6}/g);switch(a){case"143463":case"143465":n.searchParams.set("q",t.replace(/%2F[a-z]{2}-[A-Z]{2}/,"%2Fzh-HK"));break;case"143464":n.searchParams.set("q",t.replace(/%2F[a-z]{2}-[A-Z]{2}/,"%2Fzh-SG"));break;case"143470":n.searchParams.set("q",t.replace(/%2F[a-z]{2}-[A-Z]{2}/,"%2Fzh-TW"))}break;case"apps":case"music":default:n.searchParams.set("card_locale",`${s}_${e.CountryCode}`);break;case"dictionary":switch(s){case"zh-Hans":case"zh-Hant":n.searchParams.set("card_locale",`en_${e.CountryCode}`)}}}case"guzzoni.smoot.apple.com":case"fbs.smoot.apple.com":case"cdn.smoot.apple.com":}case"CONNECT":case"TRACE":}$request.url=n.toString(),r("🚧 调试信息",`$request.url: ${$request.url}`,"");case!1:}})().catch((t=>function(t){switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Quantumult X":default:r("","❗️执行错误!",t,"");break;case"Node.js":r("","❗️执行错误!",t.stack,"")}}(t))).finally((()=>{if(void 0===c)a($request);else if(c.headers,c.headers,"Quantumult X"===e)c.status||(c.status="HTTP/1.1 200 OK"),delete c.headers?.["Content-Length"],delete c.headers?.["content-length"],delete c.headers?.["Transfer-Encoding"],a(c);else a({response:c})}));
